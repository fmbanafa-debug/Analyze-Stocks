<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Stock Watchlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            width: 90%;
            max-width: 400px;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* AI Analyst Chat Styles */
        #chatHistory {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .chat-message {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
        }
        .user-message {
            background-color: #dbeafe; /* blue-100 */
            margin-left: auto;
            text-align: right;
        }
        .ai-message {
            background-color: #f3f4f6; /* gray-100 */
            margin-right: auto;
            text-align: left;
        }
         .ai-message strong { font-weight: 600; }
         .ai-message ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; }
         .ai-message br { content: ""; display: block; margin-bottom: 0.5em; }
         
        /* Enhanced Drag and Drop style */
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border-color: #3b82f6;
        }

        /* Search with clear button */
        .search-container {
            position: relative;
        }
        .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #9ca3af;
        }
        /* Highlight selected rows */
        .row-selected {
            background-color: #eff6ff !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center justify-center">
                <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                AI Stock Watchlist
            </h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Search and Add Manual -->
            <div class="lg:col-span-1 space-y-4">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search by stock symbol or name..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition pr-10">
                    <button id="clearSearchBtn" class="clear-search hidden">&times;</button>
                </div>
                <div class="flex space-x-2">
                    <button id="addStockBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition flex items-center justify-center text-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Stock
                    </button>
                    <button id="bulkUploadBtn" class="w-full bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-purple-700 transition flex items-center justify-center text-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Bulk Upload
                    </button>
                    <button id="exportBtn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition flex items-center justify-center text-sm hidden">
                         <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Export Selected
                    </button>
                </div>
            </div>
            <!-- Screenshot Upload -->
            <div class="lg:col-span-2">
                 <label for="screenshotUpload" id="screenshotLabel" class="drop-zone flex flex-col items-center justify-center h-full">
                     <svg class="w-10 h-10 mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16v-4a4 4 0 00-4-4H8a4 4 0 00-4 4v4m16 0l-3-3m-13 0l3-3"></path></svg>
                    <span class="font-semibold">Drag & Drop Screenshot Here</span>
                    <span class="text-sm">or click to browse</span>
                </label>
                <input type="file" id="screenshotUpload" class="hidden" accept="image/*">
                <input type="file" id="bulkUploadInput" class="hidden" accept=".txt,.json">
            </div>
        </div>

        <div id="last-updated-container" class="text-center text-sm text-gray-500 mb-4"></div>

        <!-- Stock Table -->
        <div class="card">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">
                                <input type="checkbox" id="selectAllCheckbox" class="rounded">
                            </th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="symbol">Symbol</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="name">Name</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer text-center" data-sort="price">Price</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer text-center" data-sort="change">Change</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer text-center" data-sort="changePercent">% Change</th>
                            <th scope="col" class="px-6 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="text-center text-xs text-gray-500 mt-2 md:hidden">
            ⟷ Scroll table horizontally ⟷
        </div>
    </div>

    <!-- Modals -->
    <div id="loadingModal" class="modal-overlay hidden"><div class="modal-content text-center"><div class="loader mx-auto"></div><p class="mt-4 text-gray-700 font-semibold">AI is analyzing...</p></div></div>

    <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Edit Stock</h2>
            <form id="editForm">
                <div class="mb-4">
                    <label for="editSymbol" class="block text-sm font-medium text-gray-700">Symbol</label>
                    <input type="text" id="editSymbol" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="editName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="editName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="editPrice" class="block text-sm font-medium text-gray-700">Price</label>
                    <input type="number" step="0.01" id="editPrice" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addModal" class="modal-overlay hidden">
         <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Add New Stock</h2>
            <form id="addForm">
                <div class="mb-4">
                    <label for="addSymbol" class="block text-sm font-medium text-gray-700">Symbol</label>
                    <input type="text" id="addSymbol" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="addName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="addName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="addPrice" class="block text-sm font-medium text-gray-700">Price</label>
                    <input type="number" step="0.01" id="addPrice" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="deleteModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
            <p class="text-gray-600 mb-6">Are you sure you want to delete <span id="deleteStockSymbol" class="font-semibold"></span>?</p>
            <div class="flex justify-center gap-4">
                <button class="cancel-btn bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="text-xl font-bold mb-4">Exported Stock List</h2>
            <p class="text-sm text-gray-600 mb-4">You can copy the list below.</p>
            <textarea id="exportData" class="w-full h-48 p-2 border border-gray-300 rounded-md font-mono text-sm" readonly></textarea>
            <div class="flex justify-end gap-3 mt-6">
                <button class="cancel-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Close</button>
                <button id="copyExportBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- AI Analyst Modal -->
    <div id="analystModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">AI Analyst: <span id="analystStockSymbol"></span></h2>
                <button class="cancel-btn text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="chatHistory">
                 <div class="ai-message chat-message">Hello! I'm your AI Analyst. Select a topic below and I'll find the latest information for you.</div>
            </div>
             <div id="analystLoading" class="hidden text-center p-4">
                <div class="loader mx-auto"></div>
                <p class="text-sm text-gray-600 mt-2">Searching for the latest information...</p>
            </div>
            <form id="analystForm" class="flex gap-2">
                <select id="analystQuestionSelect" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm bg-white">
                    <option value="revenue">Latest Yearly Revenue</option>
                    <option value="profit">Latest Yearly Net Profit</option>
                    <option value="announcement">Last Major Announcement</option>
                </select>
                <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Ask</button>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="text-xl font-bold mb-4">Bulk Upload Preview</h2>
            <div id="bulkUploadPreview" class="mb-4 max-h-64 overflow-y-auto border p-2 rounded bg-gray-50"></div>
            <div id="bulkUploadError" class="text-red-600 font-semibold text-sm mb-4 hidden"></div>
            <p class="text-xs text-gray-500 mb-4">
                Upload a .json or .txt file. Duplicates will be skipped.<br>
                <b>.json format:</b> An array of objects, e.g., <code>[{"symbol":"GOOG","name":"Google","price":150.00}]</code> <br>
                <b>.txt format:</b> Comma-separated values (CSV), one per line, e.g., <code>TSLA,Tesla Inc,180.00</code>
            </p>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmBulkUploadBtn" disabled class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed">Add Stocks</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Core elements
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const lastUpdatedContainer = document.getElementById('last-updated-container');
        const stockTableBody = document.getElementById('stockTableBody');
        const tableHeader = document.querySelector('thead');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const exportBtn = document.getElementById('exportBtn');

        // Modal Elements
        const addStockBtn = document.getElementById('addStockBtn');
        const screenshotUploadInput = document.getElementById('screenshotUpload');
        const screenshotLabel = document.getElementById('screenshotLabel');
        const loadingModal = document.getElementById('loadingModal');
        const addModal = document.getElementById('addModal');
        const editModal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteModal');
        const exportModal = document.getElementById('exportModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const addForm = document.getElementById('addForm');
        const editForm = document.getElementById('editForm');
        const copyExportBtn = document.getElementById('copyExportBtn');
        
        // Bulk Upload elements
        const bulkUploadBtn = document.getElementById('bulkUploadBtn');
        const bulkUploadInput = document.getElementById('bulkUploadInput');
        const bulkUploadModal = document.getElementById('bulkUploadModal');
        const bulkUploadPreview = document.getElementById('bulkUploadPreview');
        const bulkUploadError = document.getElementById('bulkUploadError');
        const confirmBulkUploadBtn = document.getElementById('confirmBulkUploadBtn');
        let parsedBulkStocks = [];
        
        // Analyst Modal Elements
        const analystModal = document.getElementById('analystModal');
        const analystForm = document.getElementById('analystForm');
        const analystQuestionSelect = document.getElementById('analystQuestionSelect');
        const chatHistory = document.getElementById('chatHistory');
        const analystStockSymbol = document.getElementById('analystStockSymbol');
        const analystLoading = document.getElementById('analystLoading');

        let editingStockIndex = null;
        let deletingStockIndex = null;
        let analyzingStock = null;
        let stocks = [];
        let filteredStocks = [];
        let selectedSymbols = new Set();
        let sortColumn = 'symbol';
        let sortDirection = 'asc';

        // --- Data Persistence Setup ---
        const stockDataKey = 'aiStockWatchlistData';
        
        function saveStocks() {
            localStorage.setItem(stockDataKey, JSON.stringify(stocks));
        }

        function loadStocks() {
            const savedStocks = localStorage.getItem(stockDataKey);
            if (savedStocks && savedStocks.length > 2) {
                stocks = JSON.parse(savedStocks);
            } else {
                // Default list if nothing is saved
                stocks = [
                    { symbol: 'ABEO', name: 'Abeona Therapeutics Inc.', price: 5.38, change: -0.26, changePercent: '-4.61%' },
                    { symbol: 'ABVX', name: 'ABVC BioPharma Inc.', price: 82.30, change: -1.01, changePercent: '-1.21%' },
                    { symbol: 'ACAD', name: 'ACADIA Pharmaceuticals Inc.', price: 24.42, change: -0.34, changePercent: '-1.35%' },
                    { symbol: 'ACB', name: 'Aurora Cannabis Inc.', price: 5.09, change: -0.09, changePercent: '-1.74%' },
                    { symbol: 'ACHR', name: 'Archer Aviation Inc.', price: 9.86, change: 0.61, changePercent: '+6.59%' },
                    { symbol: 'AI', name: 'C3.ai Inc.', price: 17.90, change: -0.12, changePercent: '-0.67%' },
                    { symbol: 'AMC', name: 'AMC Entertainment Holdings Inc.', price: 3.01, change: 0.17, changePercent: '+5.99%' },
                    { symbol: 'ARM', name: 'Arm Holdings plc', price: 142.91, change: -3.63, changePercent: '-2.48%' },
                    { symbol: 'GME', name: 'GameStop Corp.', price: 26.08, change: 0.20, changePercent: '+0.77%' },
                    { symbol: 'HOOD', name: 'Robinhood Markets Inc.', price: 124.78, change: 3.87, changePercent: '+3.20%' },
                    { symbol: 'IONQ', name: 'IonQ Inc.', price: 70.41, change: 3.60, changePercent: '+5.39%' },
                    { symbol: 'LCID', name: 'Lucid Group Inc.', price: 21.10, change: 0.60, changePercent: '+2.93%' },
                    { symbol: 'PLTR', name: 'Palantir Technologies Inc.', price: 182.39, change: 5.42, changePercent: '+3.06%' },
                    { symbol: 'RIVN', name: 'Rivian Automotive Inc.', price: 14.38, change: -0.30, changePercent: '-2.04%' },
                    { symbol: 'SOFI', name: 'SoFi Technologies Inc.', price: 29.51, change: 1.40, changePercent: '+4.98%' },
                    { symbol: 'SOUN', name: 'SoundHound AI Inc.', price: 16.25, change: 0.62, changePercent: '+3.97%' },
                    { symbol: 'U', name: 'Unity Software Inc.', price: 46.05, change: 0.60, changePercent: '+1.32%' }
                ];
            }
        }
        
        // --- Gemini AI Functions ---
        async function extractStockInfoFromImage(base64ImageData) {
            loadingModal.querySelector('p').textContent = 'AI is analyzing your screenshot...';
            loadingModal.classList.remove('hidden');
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const prompt = `Analyze the provided screenshot of a stock ticker or financial website. Extract the stock symbol, company name, and current price. Return a single JSON object with keys: "symbol", "name", and "price". Price should be a number. Use null for missing values.`;

            const payload = {
                contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/png", data: base64ImageData } } ] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { "symbol": { "type": "STRING" }, "name": { "type": "STRING" }, "price": { "type": "NUMBER" } } }
                }
            };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    document.getElementById('addSymbol').value = data.symbol?.toUpperCase() || '';
                    document.getElementById('addName').value = data.name || '';
                    document.getElementById('addPrice').value = data.price || '';
                    addModal.classList.remove('hidden');
                } else {
                    throw new Error("Could not extract stock information.");
                }

            } catch (error) {
                console.error('Error during AI extraction:', error);
            } finally {
                loadingModal.classList.add('hidden');
            }
        }
        
        async function getAIAnalysis(stock, query) {
            analystLoading.classList.remove('hidden');
            analystForm.classList.add('hidden');

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are a world-class financial analyst named 'Gem'. Provide concise, insightful, easy-to-understand analysis on stocks using real-time search data. Format answers with markdown (bolding, bullet points). Start with a brief, friendly greeting.";
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed: ${response.statusText}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                appendMessage(text || "I'm sorry, I couldn't find a clear answer for that. Please try another question.", 'ai');
            } catch (error) {
                console.error('Error during AI analysis:', error);
                appendMessage(`There was an error: ${error.message}`, 'ai');
            } finally {
                analystLoading.classList.add('hidden');
                analystForm.classList.remove('hidden');
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', `${sender}-message`);
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\* (.*?)(?=\n\* |\n\n|$)/g, '<li>$1</li>');
            html = html.replace(/(\r\n|\n|\r)/g, "<br>");
            html = html.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
            html = html.replace(/<\/ul><br><ul>/g, '');
            messageDiv.innerHTML = html;
            chatHistory.appendChild(messageDiv);
        }

        // --- Bulk Upload Functions ---
        function parseFileContent(content, fileType) {
            try {
                if (fileType === 'json') {
                    const data = JSON.parse(content);
                    if (!Array.isArray(data)) {
                        return { success: false, error: 'JSON file should contain an array of stocks.' };
                    }
                    const validStocks = data.filter(item => item.symbol && item.name && typeof item.price === 'number');
                    return { success: true, stocks: validStocks };
                } else if (fileType === 'txt') {
                    const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                    const validStocks = lines.map(line => {
                        const parts = line.split(',');
                        if (parts.length !== 3) return null;
                        const price = parseFloat(parts[2]);
                        if (isNaN(price)) return null;
                        return { symbol: parts[0].trim().toUpperCase(), name: parts[1].trim(), price: price };
                    }).filter(Boolean); // remove nulls
                    return { success: true, stocks: validStocks };
                }
            } catch (e) {
                return { success: false, error: 'Failed to parse file. Please check its format.' };
            }
            return { success: false, error: 'Unsupported file type.' };
        }

        function displayUploadPreview(result) {
            bulkUploadPreview.innerHTML = '';
            bulkUploadError.classList.add('hidden');
            confirmBulkUploadBtn.disabled = true;

            if (!result.success || result.stocks.length === 0) {
                bulkUploadError.textContent = result.error || 'No valid stocks found in the file.';
                bulkUploadError.classList.remove('hidden');
                parsedBulkStocks = [];
            } else {
                parsedBulkStocks = result.stocks;
                const list = document.createElement('ul');
                list.className = 'text-sm space-y-1';
                parsedBulkStocks.forEach(stock => {
                    const li = document.createElement('li');
                    li.textContent = `${stock.symbol} - ${stock.name} - $${stock.price.toFixed(2)}`;
                    list.appendChild(li);
                });
                bulkUploadPreview.appendChild(list);
                confirmBulkUploadBtn.disabled = false;
            }
            bulkUploadModal.classList.remove('hidden');
        }
        
        function handleBulkUploadFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const extension = file.name.split('.').pop().toLowerCase();
                const result = parseFileContent(e.target.result, extension);
                displayUploadPreview(result);
            };
            reader.readAsText(file);
            bulkUploadInput.value = ''; // Reset for re-uploading same file
        }

        // --- Table Rendering and Logic ---
        function renderTable() {
            stockTableBody.innerHTML = '';
            if (filteredStocks.length === 0) {
                 stockTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">No matching stocks found.</td></tr>`;
                 return;
            }
            filteredStocks.forEach(stock => {
                const isSelected = selectedSymbols.has(stock.symbol);
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-gray-50 ${isSelected ? 'row-selected' : ''}`;
                row.dataset.symbol = stock.symbol;

                const changeColor = stock.change >= 0 ? 'text-green-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" class="row-checkbox rounded" data-symbol="${stock.symbol}" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 font-medium text-blue-600 whitespace-nowrap">
                         <a href="#" class="hover:underline stock-link">${stock.symbol}</a>
                    </td>
                    <td class="px-6 py-4">${stock.name}</td>
                    <td class="px-6 py-4 text-center font-medium">${stock.price.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center ${changeColor}">${stock.change.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center ${changeColor}">${stock.changePercent}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex justify-center items-center space-x-2">
                            <button title="AI Analyst" data-action="analyze" class="p-1 text-yellow-500 hover:text-yellow-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                            </button>
                            <button title="Edit" data-action="edit" class="p-1 text-blue-500 hover:text-blue-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button title="Delete" data-action="delete" class="p-1 text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </td>
                `;
                stockTableBody.appendChild(row);
            });
            updateSelectAllCheckboxState();
        }

        function updateSortIndicators() {
            document.querySelectorAll('thead th[data-sort]').forEach(th => {
                let text = th.textContent.replace(' ▲', '').replace(' ▼', '');
                if (th.dataset.sort === sortColumn) {
                    text += sortDirection === 'asc' ? ' ▲' : ' ▼';
                }
                th.textContent = text;
            });
        }

        function filterAndSort() {
            const searchTerm = searchInput.value.toLowerCase();
            filteredStocks = stocks.filter(s => s.symbol.toLowerCase().includes(searchTerm) || s.name.toLowerCase().includes(searchTerm));
            
            filteredStocks.sort((a, b) => {
                let valA = a[sortColumn], valB = b[sortColumn];
                if (['price', 'change'].includes(sortColumn)) {
                    valA = (typeof valA === 'number') ? valA : -Infinity;
                    valB = (typeof valB === 'number') ? valB : -Infinity;
                }
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                return 0;
            });

            updateSortIndicators();
            renderTable();
        }
        
        // --- Selection and Export Logic ---
        function updateExportButtonVisibility() {
            if (selectedSymbols.size > 0) {
                exportBtn.classList.remove('hidden');
            } else {
                exportBtn.classList.add('hidden');
            }
        }

        function updateSelectAllCheckboxState() {
            const filteredSymbols = filteredStocks.map(s => s.symbol);
            const allVisibleSelected = filteredSymbols.length > 0 && filteredSymbols.every(s => selectedSymbols.has(s));
            selectAllCheckbox.checked = allVisibleSelected;
        }
        
        function getStockLink(symbol) {
             const exchange = (symbol.length <= 3 || symbol.includes('.')) ? 'NYSE' : 'NASDAQ';
             return `https://www.google.com/finance/quote/${symbol}:${exchange}`;
        }
        
        // --- Event Listeners ---
        function handleImageFile(file) {
             if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    extractStockInfoFromImage(reader.result.replace('data:', '').replace(/^.+,/, ''));
                };
                reader.readAsDataURL(file);
            }
        }

        bulkUploadBtn.addEventListener('click', () => {
            bulkUploadInput.click();
        });

        bulkUploadInput.addEventListener('change', (e) => {
            handleBulkUploadFile(e.target.files[0]);
        });
        
        confirmBulkUploadBtn.addEventListener('click', () => {
            if (parsedBulkStocks.length > 0) {
                const existingSymbols = new Set(stocks.map(s => s.symbol));
                const newStocks = parsedBulkStocks.filter(s => !existingSymbols.has(s.symbol));
                
                newStocks.forEach(stock => {
                    stocks.unshift({
                        symbol: stock.symbol,
                        name: stock.name,
                        price: stock.price,
                        change: 0,
                        changePercent: '0.00%'
                    });
                });

                saveStocks();
                filterAndSort();
                bulkUploadModal.classList.add('hidden');
                parsedBulkStocks = [];
            }
        });

        screenshotUploadInput.addEventListener('change', (event) => {
            handleImageFile(event.target.files[0]);
            event.target.value = '';
        });
        
        screenshotLabel.addEventListener('dragover', (e) => { e.preventDefault(); screenshotLabel.classList.add('drag-over'); });
        screenshotLabel.addEventListener('dragleave', () => { screenshotLabel.classList.remove('drag-over'); });
        screenshotLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            screenshotLabel.classList.remove('drag-over');
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                handleImageFile(e.dataTransfer.files[0]);
                e.dataTransfer.clearData();
            }
        });

        tableHeader.addEventListener('click', (e) => {
            const th = e.target.closest('th');
            if (th && th.dataset.sort) {
                const key = th.dataset.sort;
                if (sortColumn === key) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = key;
                    sortDirection = 'asc';
                }
                filterAndSort();
            }
        });
        
        selectAllCheckbox.addEventListener('change', () => {
            const filteredSymbols = filteredStocks.map(s => s.symbol);
            if (selectAllCheckbox.checked) {
                filteredSymbols.forEach(symbol => selectedSymbols.add(symbol));
            } else {
                filteredSymbols.forEach(symbol => selectedSymbols.delete(symbol));
            }
            updateExportButtonVisibility();
            renderTable();
        });

        stockTableBody.addEventListener('click', e => {
            const checkbox = e.target.closest('input.row-checkbox');
            const button = e.target.closest('button[data-action]');
            const link = e.target.closest('a.stock-link');
            const row = e.target.closest('tr');
            if (!row) return;

            const symbol = row.dataset.symbol;
            const stock = stocks.find(s => s.symbol === symbol);
            const originalIndex = stocks.findIndex(s => s.symbol === symbol);
            if (!stock) return;
            
            if (checkbox) {
                if (checkbox.checked) {
                    selectedSymbols.add(symbol);
                } else {
                    selectedSymbols.delete(symbol);
                }
                row.classList.toggle('row-selected', checkbox.checked);
                updateExportButtonVisibility();
                updateSelectAllCheckboxState();
                return; // Prevent other actions when clicking checkbox
            }

            if (button) {
                 const action = button.dataset.action;
                 if (action === 'analyze') {
                    analyzingStock = stock;
                    analystStockSymbol.textContent = stock.symbol;
                    chatHistory.innerHTML = '<div class="ai-message chat-message">Hello! I\'m your AI Analyst. Select a topic below and I\'ll find the latest information for you.</div>';
                    analystModal.classList.remove('hidden');
                } else if (action === 'edit') {
                    editingStockIndex = originalIndex;
                    document.getElementById('editSymbol').value = stock.symbol;
                    document.getElementById('editName').value = stock.name;
                    document.getElementById('editPrice').value = stock.price;
                    editModal.classList.remove('hidden');
                } else if (action === 'delete') {
                    deletingStockIndex = originalIndex;
                    document.getElementById('deleteStockSymbol').textContent = stock.symbol;
                    deleteModal.classList.add('hidden');
                }
            } else if (link) {
                 e.preventDefault();
                 window.open(getStockLink(symbol), '_blank');
            }
        });

        analystForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedOption = analystQuestionSelect.options[analystQuestionSelect.selectedIndex];
            const queryType = selectedOption.value;
            const queryText = selectedOption.textContent;

            if (queryType && analyzingStock) {
                appendMessage(queryText, 'user');
                let fullQuery = '';
                switch (queryType) {
                    case 'revenue':
                        fullQuery = `What was the latest reported annual revenue for ${analyzingStock.name} (${analyzingStock.symbol})? Please provide the amount and the fiscal year.`;
                        break;
                    case 'profit':
                        fullQuery = `What was the latest reported annual net profit for ${analyzingStock.name} (${analyzingStock.symbol})? Please provide the amount and the fiscal year.`;
                        break;
                    case 'announcement':
                        fullQuery = `What was the last major news or announcement that caused the biggest price shift (up or down) for ${analyzingStock.name} (${analyzingStock.symbol}) in the past year? Briefly explain the event and its impact.`;
                        break;
                }
                getAIAnalysis(analyzingStock, fullQuery);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });
        
        addStockBtn.addEventListener('click', () => addModal.classList.remove('hidden'));

        // Close modals logic
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal || e.target.classList.contains('cancel-btn')) {
                    modal.classList.add('hidden');
                }
            });
        });

        addForm.addEventListener('submit', e => {
            e.preventDefault();
            const symbol = document.getElementById('addSymbol').value.toUpperCase();
            const name = document.getElementById('addName').value;
            const price = parseFloat(document.getElementById('addPrice').value);
            if (symbol && name && !isNaN(price)) {
                stocks.unshift({ symbol, name, price, change: 0, changePercent: '0.00%' });
                saveStocks();
                addModal.classList.add('hidden');
                addForm.reset();
                filterAndSort(); 
            }
        });
        
        editForm.addEventListener('submit', e => {
            e.preventDefault();
            if (editingStockIndex !== null) {
                const stockToEdit = stocks[editingStockIndex];
                if (stockToEdit) {
                    const newSymbol = document.getElementById('editSymbol').value.toUpperCase();
                    const newName = document.getElementById('editName').value;
                    const newPrice = parseFloat(document.getElementById('editPrice').value);
                    
                    const originalPrice = stockToEdit.price;
                     if (typeof originalPrice === 'number' && !isNaN(originalPrice) && originalPrice !== 0 && newPrice !== originalPrice) {
                        stockToEdit.change = newPrice - originalPrice;
                        stockToEdit.changePercent = ((stockToEdit.change / originalPrice) * 100).toFixed(2) + '%';
                    }
                    stockToEdit.symbol = newSymbol;
                    stockToEdit.name = newName;
                    stockToEdit.price = newPrice;
                    saveStocks();
                }
                editModal.classList.add('hidden');
                editingStockIndex = null;
                filterAndSort();
            }
        });

        confirmDeleteBtn.addEventListener('click', () => {
             if (deletingStockIndex !== null) {
                stocks.splice(deletingStockIndex, 1);
                saveStocks();
                deleteModal.classList.add('hidden');
                deletingStockIndex = null;
                filterAndSort(); 
             }
        });
        
        // Search input logic
        searchInput.addEventListener('input', () => {
            clearSearchBtn.classList.toggle('hidden', searchInput.value.length === 0);
            filterAndSort();
        });
        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearSearchBtn.classList.add('hidden');
            filterAndSort();
            searchInput.focus();
        });

        // Export logic
        exportBtn.addEventListener('click', () => {
            let exportText = 'Symbol\tName\tPrice\tLink\n';
            selectedSymbols.forEach(symbol => {
                const stock = stocks.find(s => s.symbol === symbol);
                if(stock) {
                    exportText += `${stock.symbol}\t${stock.name}\t${stock.price.toFixed(2)}\t${getStockLink(stock.symbol)}\n`;
                }
            });
            document.getElementById('exportData').value = exportText;
            exportModal.classList.remove('hidden');
        });
        
        copyExportBtn.addEventListener('click', () => {
            const exportData = document.getElementById('exportData');
            exportData.select();
            document.execCommand('copy');
            copyExportBtn.textContent = 'Copied!';
            setTimeout(() => { copyExportBtn.textContent = 'Copy to Clipboard'; }, 2000);
        });

        // --- Initial App Start ---
        function init() {
            loadStocks();
            lastUpdatedContainer.textContent = `Prices as of: ${new Date().toLocaleDateString()}`;
            filterAndSort();
        }
        
        init();
    });
    </script>
</body>
</html>

